<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Dispatch Controller ‚Äî Glass UI</title>
<style>
/* ---------- Base (desktop-first) ---------- */
:root{
  --glass-bg: rgba(255,255,255,0.08);
  --glass-strong: rgba(255,255,255,0.15);
  --accent: #ffd700;
  --danger: #ff394f;
  --shadow: rgba(0,0,0,0.25);
}

html,body{height:100%}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  background:url('bg.jpg') no-repeat center/cover;
  background-size:cover;
  font-family:'SF Pro Display','Segoe UI',Roboto,sans-serif;
  color:white;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* container holds app after login */
.container{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:95%;
  max-width:1300px;
  padding-top:64px;
  gap:30px;
  position:relative;
  box-sizing:border-box;
}

/* pending area */
.pending-zones{
  display:flex;
  justify-content:flex-start;
  flex-wrap:wrap;
  gap:15px;
  padding:15px;
  background:var(--glass-bg);
  backdrop-filter:blur(20px) saturate(180%);
  border-radius:25px;
  box-shadow:inset 0 0 25px rgba(255,255,255,0.1),0 0 20px rgba(0,0,0,0.2);
  min-height:74px;
  width:100%;
  box-sizing:border-box;
  overflow-y:auto;
}

/* zone card */
.zone{
  min-width:100px;
  padding:10px 16px;
  border-radius:14px;
  text-align:center;
  background:var(--glass-strong);
  color:white;
  backdrop-filter:blur(15px);
  box-shadow:0 4px 15px var(--shadow);
  cursor:grab;
  transition:all .22s ease;
  font-weight:500;
  letter-spacing:.5px;
  position:relative;
  display:inline-flex;
  flex-direction:column;
  gap:6px;
  align-items:center;
  user-select:none;
  -webkit-user-select:none;
  touch-action:manipulation;
}
.zone:hover{transform:translateY(-4px) scale(1.05);background:rgba(255,255,255,0.25)}
.zone:active{cursor:grabbing}

/* bays */
.dispatch-bays{
  display:flex;
  justify-content:space-between;
  width:100%;
  gap:20px;
  box-sizing:border-box;
}
.bay{
  flex:1;
  min-height:150px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:20px;
  border-radius:20px;
  background:rgba(255,255,255,0.07);
  backdrop-filter:blur(15px) saturate(180%);
  box-shadow:0 10px 30px var(--shadow),inset 0 0 15px rgba(255,255,255,0.1);
  transition:background .3s ease;
  gap:8px;
  overflow-y:auto;
}
.bay:hover{background:rgba(255,255,255,0.15)}

.dispatched-zones{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
  background:var(--glass-bg);
  backdrop-filter:blur(18px) saturate(180%);
  border-radius:20px;
  box-shadow:inset 0 0 25px rgba(255,255,255,0.1),0 0 20px rgba(0,0,0,0.2);
  padding:15px;
  max-width:100%;
  min-height:64px;
  box-sizing:border-box;
}

/* badges & small text */
.timer,.dispatched-time{display:block;margin-top:4px;font-size:.8rem;opacity:.85;color:var(--accent);text-shadow:0 0 8px rgba(0,0,0,.4)}
.top-actions{position:absolute;top:8px;right:8px;display:flex;gap:12px;z-index:40}
.action-btn{width:44px;height:44px;border-radius:22px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);box-shadow:0 8px 20px var(--shadow);cursor:pointer;transition:transform .12s ease,background .12s ease}
.action-btn:hover{transform:translateY(-3px);background:rgba(255,255,255,0.1)}
.pending-controls{position:absolute;left:18px;top:-10px;z-index:30}
.add-zone-btn{width:40px;height:40px;border-radius:20px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);box-shadow:0 8px 18px var(--shadow);cursor:pointer}
.add-zone-btn:hover{transform:translateY(-2px);background:rgba(255,255,255,0.1)}
.minus-dot{position:absolute;top:-8px;left:-8px;width:22px;height:22px;border-radius:11px;background:var(--danger);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,0.35);cursor:pointer;transform:scale(0);transition:transform .12s ease;z-index:60}
.zone.show-minus .minus-dot{transform:scale(1)}
.seq-badge{position:absolute;top:-8px;right:-8px;min-width:22px;height:22px;border-radius:11px;padding:0 6px;display:flex;align-items:center;justify-content:center;background:var(--danger);color:white;font-size:12px;font-weight:700;box-shadow:0 8px 18px rgba(0,0,0,0.35);z-index:59;pointer-events:none;display:none}
.name{font-weight:600}
.bay::-webkit-scrollbar,.pending-zones::-webkit-scrollbar{height:8px;width:8px}
.bay::-webkit-scrollbar-thumb,.pending-zones::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:4px}

/* Login modal (glass) */
#loginOverlay{position:fixed;inset:0;background:rgba(3,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
#loginBox{width:360px;max-width:90%;padding:22px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));backdrop-filter: blur(16px) saturate(150%);box-shadow:0 10px 40px rgba(0,0,0,0.6);color:#fff;display:flex;flex-direction:column;gap:12px}
#loginBox h3{margin:0;font-size:18px;font-weight:700}
.login-row{display:flex;flex-direction:column;gap:6px}
.login-row input{height:40px;border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:white;outline:none}
.login-actions{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px}
.login-actions button{height:40px;border-radius:10px;padding:0 12px;background:rgba(255,255,255,0.06);border:none;color:white;cursor:pointer}
.login-small{font-size:12px;opacity:.85}
.login-link{font-size:12px;color:var(--accent);cursor:pointer;text-decoration:underline}

/* small helper */
.small-muted{font-size:12px;opacity:.8;color:#ddd}

/* ---------- Responsive: tablet and mobile ---------- */

/* tablet */
@media (max-width: 1000px) {
  .container{padding-top:48px;gap:18px}
  .pending-zones{gap:12px;padding:12px;border-radius:20px;min-height:68px}
  .zone{min-width:90px;padding:9px 12px;border-radius:12px;font-size:.95rem}
  .dispatch-bays{gap:12px}
  .bay{min-height:140px;padding:16px;border-radius:16px}
  .top-actions{top:10px;right:10px}
}

/* mobile (phones) */
@media (max-width: 640px) {
  /* container uses smaller padding */
  .container{padding-top:18px;gap:14px;width:98%;}

  /* pending zones switch to single-line horizontal scroll for easier thumb use */
  .pending-zones{
    flex-wrap:nowrap;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    padding:12px 10px;
    gap:12px;
    min-height:86px;
  }
  .pending-zones::-webkit-scrollbar{height:10px}
  .pending-zones::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:6px}

  /* make zone cards more compact & touch-friendly */
  .zone{min-width:88px;padding:12px 14px;border-radius:12px;font-size:0.95rem;box-shadow:0 8px 20px rgba(0,0,0,0.4)}
  .zone .name{font-size:0.95rem}

  /* stack bays vertically to avoid horizontal squish */
  .dispatch-bays{flex-direction:column;gap:12px}
  .bay{width:100%;min-height:120px;padding:14px;border-radius:14px;overflow:auto}

  /* move top-actions to bottom fixed bar to avoid overlapping content */
  .top-actions{
    position:fixed;
    left:10px;
    right:10px;
    bottom:12px;
    top:auto;
    justify-content:center;
    gap:10px;
    z-index:60;
    display:flex;
  }
  .action-btn{width:48px;height:48px;border-radius:12px;font-size:18px}

  /* make add button more prominent on mobile */
  .pending-controls{position:fixed;right:12px;bottom:84px;left:auto;top:auto;z-index:60}
  .add-zone-btn{width:52px;height:52px;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,0.6)}
  .minus-dot{top:-10px;left:-10px;width:26px;height:26px;border-radius:13px}

  /* login box full width */
  #loginBox{width:92%;padding:20px}
  #loginBox h3{font-size:17px}
  .login-row input{height:44px;padding:12px 14px}
  .login-actions button{height:44px;padding:8px 16px}
}

/* extra small phones */
@media (max-width:420px) {
  .zone{min-width:84px;padding:10px 12px}
  .pending-zones{min-height:96px;padding:10px}
  .bay{min-height:110px;padding:12px}
  .action-btn{width:44px;height:44px}
  .add-zone-btn{width:48px;height:48px}
}
</style>
</head>
<body>
<!-- Login overlay -->
<div id="loginOverlay" style="display:flex">
  <div id="loginBox" role="dialog" aria-modal="true">
    <h3>Sign in ‚Äî Dispatch Controller</h3>
    <div class="login-row">
      <label class="small-muted">Username</label>
      <input id="loginUser" placeholder="Username" autocomplete="off" />
    </div>
    <div class="login-row">
      <label class="small-muted">Password</label>
      <input id="loginPass" type="password" placeholder="Password" autocomplete="off" />
    </div>
    <div class="login-row" style="flex-direction:row;align-items:center;justify-content:space-between">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="rememberChk" type="checkbox" />
        <span class="login-small">Remember (saved for this tab)</span>
      </label>
      <span class="login-small login-link" id="clearSaved" title="Clear saved credentials">Clear saved</span>
    </div>
    <div class="login-actions">
      <div class="left"><!-- intentionally blank --></div>
      <div>
        <button id="loginBtn">Sign in</button>
      </div>
    </div>
  </div>
</div>

<!-- Main app (hidden until login) -->
<div class="container" style="display:none">
  <div class="top-actions">
    <div id="downloadBtn" class="action-btn" title="Download CSV">üìä</div>
    <div id="resetBtn" class="action-btn" title="Reset all to pending">üîÑ</div>
    <div id="editToggleBtn" class="action-btn" title="Toggle edit mode">‚úèÔ∏è</div>
  </div>

  <div class="pending-controls">
    <div id="addBtn" class="add-zone-btn" title="Add Zone">‚ûï</div>
  </div>

  <div class="pending-zones" id="pendingZones">
    <div class="zone" draggable="true" id="Fujairah"><span class="name">Fujairah</span></div>
    <div class="zone" draggable="true" id="RasAlKhaimah"><span class="name">Ras Al Khaimah</span></div>
    <div class="zone" draggable="true" id="JabalAli"><span class="name">Jabal Ali</span></div>
    <div class="zone" draggable="true" id="AlQuoz2"><span class="name">Al Quoz 2</span></div>
    <div class="zone" draggable="true" id="AlQuoz1"><span class="name">Al Quoz 1</span></div>
    <div class="zone" draggable="true" id="Mirdiff"><span class="name">Mirdiff</span></div>
    <div class="zone" draggable="true" id="BurDubai"><span class="name">Bur Dubai</span></div>
    <div class="zone" draggable="true" id="SharjahBuhairah"><span class="name">Sharjah-Buhairah</span></div>
    <div class="zone" draggable="true" id="Jumeirah"><span class="name">Jumeirah</span></div>
    <div class="zone" draggable="true" id="AlQusais"><span class="name">Al Qusais</span></div>
    <div class="zone" draggable="true" id="Deira"><span class="name">Deira</span></div>
    <div class="zone" draggable="true" id="Ajman"><span class="name">Ajman</span></div>
    <div class="zone" draggable="true" id="SharjahSanayia"><span class="name">Sharjah-Sanayia</span></div>
  </div>

  <div class="dispatch-bays">
    <div class="bay" id="bulkBay"><h2>Bulk Bay</h2></div>
    <div class="bay" id="bay4"><h2>Dispatch Bay 4</h2></div>
    <div class="bay" id="bay3"><h2>Dispatch Bay 3</h2></div>
    <div class="bay" id="bay2"><h2>Dispatch Bay 2</h2></div>
    <!-- Modified heading for Bay 1: added small secondary text (urgent and government) as requested -->
    <div class="bay" id="bay1"><h2>Dispatch Bay 1 <small style="display:block;font-size:12px;opacity:.8;margin-top:4px;">urgent ¬∑ government</small></h2></div>
  </div>

  <div class="dispatched-zones" id="dispatchedZones"><h2>Dispatched Zones</h2></div>
</div>

<script type="module">
/* ===== Firebase + App logic (UNCHANGED except Firebase config) ===== */

// Global error handler to catch module loading failures
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error, event.filename);
  if (event.filename && (event.filename.includes('firebase') || event.filename.includes('index-8'))) {
    console.error('Module loading error:', event.error);
    if (event.error && event.error.message && event.error.message.includes('Failed to fetch')) {
      console.warn('Network error detected, will retry...');
    }
  }
}, true);

// Catch unhandled promise rejections
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  if (event.reason && typeof event.reason === 'object') {
    const msg = event.reason.message || String(event.reason);
    if (msg.includes('firebase') || msg.includes('Failed to fetch') || event.reason.code) {
      console.warn('Firebase-related error caught:', event.reason);
      event.preventDefault();
    }
  }
});

import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

// Ensure Firebase is only initialized once
let app, db;
try {
  const firebaseConfig = {
    apiKey: "AIzaSyDgtEbSRPDfr3sPPusdiLjD_2zonzREgaw",
    authDomain: "jan26-database.firebaseapp.com",
    databaseURL: "https://jan26-database-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jan26-database",
    storageBucket: "jan26-database.firebasestorage.app",
    messagingSenderId: "501382009726",
    appId: "1:501382009726:web:6d5cfb9cc04621bcb1592f",
    measurementId: "G-G66JG9G8V9"
  };

  const existingApps = getApps();
  if (existingApps.length > 0) {
    app = existingApps[0];
  } else {
    app = initializeApp(firebaseConfig);
  }
  db = getDatabase(app);
} catch (error) {
  console.error('Firebase initialization error:', error);
}

// Wait for DOM to be fully ready
function ensureDOMReady() {
  return new Promise((resolve) => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolve);
    } else {
      resolve();
    }
  });
}

// Get DOM elements with error checking
function getElement(id, required = true) {
  const el = document.getElementById(id);
  if (!el && required) {
    console.error(`Required element not found: ${id}`);
    throw new Error(`Required element not found: ${id}`);
  }
  return el;
}

// Wait for DOM, then get elements
await ensureDOMReady();

const loginOverlay = getElement('loginOverlay');
const loginBox = getElement('loginBox');
const loginBtn = getElement('loginBtn');
const loginUser = getElement('loginUser');
const loginPass = getElement('loginPass');
const rememberChk = getElement('rememberChk');
const clearSaved = getElement('clearSaved');

const containerEl = document.querySelector('.container');
if (!containerEl) throw new Error('Container element not found');

const pendingArea = getElement('pendingZones');
const dispatchedArea = getElement('dispatchedZones');
const bays = document.querySelectorAll('.bay');
if (bays.length === 0) throw new Error('No bay elements found');

const addBtn = getElement('addBtn');
const editToggleBtn = getElement('editToggleBtn');
const resetBtn = getElement('resetBtn');
const downloadBtn = getElement('downloadBtn');

let editMode = false;
let appStarted = false;

/* ---------------------------
   AUTH: localStorage-based remember
*/
function saveCredentials(username, password) {
  try { 
    localStorage.setItem('dispatch_credentials', JSON.stringify({ username, password })); 
  } catch(e){
    console.warn('localStorage not available:', e);
  }
}
function clearSavedCredentials() {
  try { 
    localStorage.removeItem('dispatch_credentials'); 
  } catch(e){
    console.warn('localStorage not available:', e);
  }
}
function getSavedCredentials() {
  try { 
    const s = localStorage.getItem('dispatch_credentials'); 
    return s ? JSON.parse(s) : null; 
  } catch(e){ 
    console.warn('localStorage not available:', e);
    return null; 
  }
}

function showAppAndHideLogin() {
  loginOverlay.style.display = 'none';
  containerEl.style.display = '';
  startApp();
}

function showLogin() {
  loginOverlay.style.display = 'flex';
  containerEl.style.display = 'none';
}

(function initAuth() {
  const saved = getSavedCredentials();
  const wasLoggedIn = sessionStorage.getItem('dispatch_logged_in') === 'true';
  
  if (saved && saved.username && saved.password) {
    loginUser.value = saved.username;
    loginPass.value = saved.password;
    rememberChk.checked = true;
    
    if (wasLoggedIn && saved.username === 'admin' && saved.password === '0000') {
      const checkFirebase = setInterval(() => {
        if (db) {
          clearInterval(checkFirebase);
          showAppAndHideLogin();
        }
      }, 100);
      setTimeout(() => {
        clearInterval(checkFirebase);
        if (!db) {
          showLogin();
        }
      }, 3000);
      return;
    }
  } else {
    loginUser.value = '';
    loginPass.value = '';
    rememberChk.checked = false;
  }
  showLogin();
})();

clearSaved.addEventListener('click', () => {
  clearSavedCredentials();
  try {
    sessionStorage.removeItem('dispatch_logged_in');
  } catch(e) {}
  rememberChk.checked = false;
  loginUser.value = '';
  loginPass.value = '';
  alert('Saved credentials cleared.');
});

loginBtn.addEventListener('click', () => {
  const u = (loginUser.value || '').trim();
  const p = (loginPass.value || '').trim();
  if (u === 'admin' && p === '0000') {
    if (rememberChk.checked) {
      saveCredentials(u,p);
    } else {
      clearSavedCredentials();
    }
    try {
      sessionStorage.setItem('dispatch_logged_in', 'true');
    } catch(e) {
      console.warn('SessionStorage not available (may be blocked by privacy settings):', e);
    }
    showAppAndHideLogin();
  } else {
    alert('Invalid credentials. Use username: admin, password: 0000');
  }
});

/* ---------------------------
   Sequence logic
*/
async function assignSequenceFirebase(zoneId) {
  if (!db) {
    console.error('Firebase not initialized');
    return null;
  }
  const tx = await runTransaction(ref(db, 'meta/nextSequence'), (cur) => {
    if (cur == null) return 1;
    return Number(cur) + 1;
  });
  const assigned = tx.snapshot.val();
  if (assigned != null) {
    await update(ref(db, 'zones/' + zoneId), { sequenceNumber: assigned });
  }
  return assigned;
}

async function freeSequenceFirebase(zoneId) {
  if (!db) {
    console.error('Firebase not initialized');
    return;
  }
  const snap = await get(ref(db, 'zones/' + zoneId + '/sequenceNumber'));
  if (!snap.exists()) return;
  const num = snap.val();
  if (num == null) return;
  const freedNum = Number(num);
  if (isNaN(freedNum)) return;
  const txZones = await runTransaction(ref(db, 'zones'), (cur) => {
    if (!cur) return cur;
    for (const k of Object.keys(cur)) {
      if (!cur[k]) continue;
      const s = cur[k].sequenceNumber;
      if (s == null) continue;
      const sNum = Number(s);
      if (k === zoneId) {
        cur[k].sequenceNumber = null;
      } else if (sNum > freedNum) {
        cur[k].sequenceNumber = sNum - 1;
      }
    }
    return cur;
  });
  if (!txZones.committed) return;
  const updatedZones = txZones.snapshot.val() || {};
  let maxAssigned = 0;
  for (const k in updatedZones) {
    const v = updatedZones[k];
    if (!v) continue;
    const s = v.sequenceNumber;
    if (s != null) {
      const n = Number(s);
      if (!isNaN(n) && n > maxAssigned) maxAssigned = n;
    }
  }
  await runTransaction(ref(db, 'meta/nextSequence'), (cur) => {
    return Number(maxAssigned);
  });
  try { await set(ref(db, 'meta/freeNumbers'), []); } catch (e){}
}

/* ---------------------------
   UI initialization functions
*/
function initZone(zone) {
  if (zone._inited) return;
  zone._inited = true;

  if (!zone.querySelector('.name')) {
    const n = document.createElement('span'); n.className = 'name'; n.textContent = zone.id; zone.appendChild(n);
  }
  if (!zone.querySelector('.seq-badge')) {
    const sb = document.createElement('div'); sb.className = 'seq-badge'; zone.appendChild(sb);
  }
  if (!zone.querySelector('.minus-dot')) {
    const md = document.createElement('div'); md.className = 'minus-dot'; md.textContent = '‚Äì';
    md.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!editMode) return;
      if (!confirm('Delete zone "' + (zone.querySelector('.name')?.textContent || zone.id) + '"?')) return;
      if (!db) {
        alert('Database not ready. Please refresh the page.');
        return;
      }
      await freeSequenceFirebase(zone.id);
      await update(ref(db, 'zones/' + zone.id), { deleted: true });
      zone.remove();
    });
    zone.appendChild(md);
  }
  if (!zone.querySelector('.timer')) {
    const t = document.createElement('span'); t.className = 'timer'; t.style.display = 'none'; zone.appendChild(t);
  }
  if (!zone.querySelector('.dispatched-time')) {
    const d = document.createElement('span'); d.className = 'dispatched-time'; d.style.display = 'none'; zone.appendChild(d);
  }

  zone.addEventListener('click', (ev) => {
    if (!editMode) return;
    ev.stopPropagation();
    const cur = zone.querySelector('.name')?.textContent || zone.id;
    const newName = prompt('Rename zone:', cur);
    if (newName && newName.trim() && db) {
      update(ref(db, 'zones/' + zone.id), { name: newName.trim() });
    }
  });

  zone.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', zone.id);
    setTimeout(() => zone.style.display = 'none', 0);
  });
  zone.addEventListener('dragend', () => zone.style.display = '');
  if (db) {
    get(ref(db, 'zones/' + zone.id)).then(snap => {
      if (!snap.exists()) {
        set(ref(db, 'zones/' + zone.id), { name: zone.querySelector('.name')?.textContent || zone.id, status: 'pending' });
      }
    }).catch(err => console.warn('Error checking zone:', err));
  }
}

async function handleDrop(zone, area) {
  if (!db) {
    alert('Database not ready. Please refresh the page.');
    return;
  }
  const now = Date.now();
  let status = 'pending';
  if (area.classList.contains('bay')) status = 'in-gate';
  else if (area.id === 'dispatchedZones') status = 'dispatched';
  else status = 'pending';

  if (status === 'in-gate') {
    const seqSnap = await get(ref(db, 'zones/' + zone.id + '/sequenceNumber'));
    if (!seqSnap.exists() || seqSnap.val() == null) await assignSequenceFirebase(zone.id);
    await update(ref(db, 'zones/' + zone.id), { status, startTime: now, bayId: area.id });
  } else if (status === 'dispatched') {
    const seqSnap = await get(ref(db, 'zones/' + zone.id + '/sequenceNumber'));
    if (!seqSnap.exists() || seqSnap.val() == null) await assignSequenceFirebase(zone.id);
    await update(ref(db, 'zones/' + zone.id), { status, dispatchedTime: now, bayId: area.id });
  } else {
    await freeSequenceFirebase(zone.id);
    await update(ref(db, 'zones/' + zone.id), { status, startTime: null, dispatchedTime: null, bayId: null });
  }
}

function enableDrop(area) {
  area.addEventListener('dragover', e => e.preventDefault());
  area.addEventListener('drop', async e => {
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const zone = document.getElementById(id);
    if (!zone) return;
    area.appendChild(zone);
    await handleDrop(zone, area);
  });
}
bays.forEach(enableDrop);
enableDrop(dispatchedArea);
enableDrop(pendingArea);

addBtn.addEventListener('click', () => {
  if (!db) {
    alert('Database not ready. Please refresh the page.');
    return;
  }
  const name = prompt('Enter new zone name:');
  if (!name || !name.trim()) return;
  const id = name.trim().replace(/\s+/g, '_') + '_' + Date.now();
  const zone = document.createElement('div');
  zone.className = 'zone';
  zone.id = id;
  zone.draggable = true;
  zone.innerHTML = `<span class="name">${name.trim()}</span>`;
  pendingArea.appendChild(zone);
  initZone(zone);
  set(ref(db, 'zones/' + id), { name: name.trim(), status: 'pending' });
});

editToggleBtn.addEventListener('click', () => {
  editMode = !editMode;
  document.querySelectorAll('.zone').forEach(z => {
    if (editMode) z.classList.add('show-minus'); else z.classList.remove('show-minus');
  });
  editToggleBtn.style.background = editMode ? 'rgba(255,255,255,0.12)' : '';
});

resetBtn.addEventListener('click', async () => {
  if (!confirm('Reset all zones to pending and restart numbering?')) return;
  if (!db) {
    alert('Database not ready. Please refresh the page.');
    return;
  }
  await set(ref(db, 'meta/nextSequence'), 0);
  await set(ref(db, 'meta/freeNumbers'), []);
  const snap = await get(ref(db, 'zones'));
  if (!snap.exists()) return;
  const zonesObj = snap.val();
  const updates = {};
  for (const id in zonesObj) {
    if (zonesObj[id] && zonesObj[id].deleted) continue;
    updates['zones/' + id + '/status'] = 'pending';
    updates['zones/' + id + '/startTime'] = null;
    updates['zones/' + id + '/dispatchedTime'] = null;
    updates['zones/' + id + '/bayId'] = null;
    updates['zones/' + id + '/sequenceNumber'] = null;
  }
  await update(ref(db, '/'), updates);
});

/* ---------------------------
   CSV export (unchanged)
*/
downloadBtn.addEventListener('click', async () => {
  if (!db) {
    alert('Database not ready. Please refresh the page.');
    return;
  }
  const snap = await get(ref(db, 'zones'));
  const obj = snap.exists() ? snap.val() : {};
  const rows = [
    [
      'zoneId',
      'name',
      'status',
      'bayId',
      'inGateStart_iso',
      'inGateStart_date_UAE',
      'inGateStart_time_UAE',
      'inGateDuration_HH:MM:SS',
      'dispatchedTime_iso',
      'dispatched_date_UAE',
      'dispatched_time_UAE',
      'sequenceNumber'
    ]
  ];

  function msToHms(ms) {
    if (ms == null) return '';
    const total = Math.floor(ms / 1000);
    const hours = Math.floor(total / 3600);
    const mins = Math.floor((total % 3600) / 60);
    const secs = total % 60;
    const pad = n => String(n).padStart(2, '0');
    return `${pad(hours)}:${pad(mins)}:${pad(secs)}`;
  }

  const dateFormatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Dubai' });
  const timeFormatter = new Intl.DateTimeFormat('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Dubai' });

  for (const id in obj) {
    const z = obj[id];
    if (!z || z.deleted) continue;

    const name = z.name || '';
    const status = z.status || '';
    const bayId = z.bayId || '';

    const inMs = z.startTime != null ? z.startTime : null;
    const inIso = inMs ? new Date(inMs).toISOString() : '';

    let inGateDur = '';
    if (z.startTime != null && z.dispatchedTime != null) {
      inGateDur = msToHms(z.dispatchedTime - z.startTime);
    }

    const dispMs = z.dispatchedTime != null ? z.dispatchedTime : null;
    const dispIso = dispMs ? new Date(dispMs).toISOString() : '';

    let inDateUAE = '';
    let inTimeUAE = '';
    if (inMs != null) {
      try {
        inDateUAE = dateFormatter.format(new Date(inMs));
        inTimeUAE = timeFormatter.format(new Date(inMs));
      } catch (e) { inDateUAE = ''; inTimeUAE = ''; }
    }

    let dispDateUAE = '';
    let dispTimeUAE = '';
    if (dispMs != null) {
      try {
        dispDateUAE = dateFormatter.format(new Date(dispMs));
        dispTimeUAE = timeFormatter.format(new Date(dispMs));
      } catch (e) { dispDateUAE = ''; dispTimeUAE = ''; }
    }

    const seq = z.sequenceNumber != null ? z.sequenceNumber : '';

    rows.push([
      `"${id.replace(/"/g, '""')}"`,
      `"${(name||'').replace(/"/g, '""')}"`,
      `"${(status||'').replace(/"/g, '""')}"`,
      `"${(bayId||'').replace(/"/g, '""')}"`,
      `"${inIso}"`,
      `"${inDateUAE}"`,
      `"${inTimeUAE}"`,
      `"${inGateDur}"`,
      `"${dispIso}"`,
      `"${dispDateUAE}"`,
      `"${dispTimeUAE}"`,
      seq
    ]);
  }

  const csv = rows.map(r => r.join(',')).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

  let dateStr = new Date().toLocaleDateString('en-CA');
  if (!dateStr) dateStr = new Date().toISOString().slice(0,10);
  dateStr = String(dateStr).replace(/\//g,'-');
  const filename = `dispatch_report_${dateStr}.csv`;

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// Set up Firebase listener - only if db is initialized
if (db) {
  onValue(ref(db, 'zones/'), snapshot => {
    const data = snapshot.val() || {};
    for (const id in data) {
      const zData = data[id] || {};
      let zone = document.getElementById(id);

      if (zData.deleted) {
        if (zone && zone.parentNode) zone.remove();
        continue;
      }

      if (!zone) {
        zone = document.createElement('div');
        zone.className = 'zone';
        zone.id = id;
        zone.draggable = true;
        zone.innerHTML = `<span class="name">${zData.name || id}</span>`;
        pendingArea.appendChild(zone);
      } else {
        const ns = zone.querySelector('.name');
        if (ns && zData.name) ns.textContent = zData.name;
      }
      initZone(zone);

      if (zData.status === 'pending') {
        pendingArea.appendChild(zone);
        zone.querySelector('.timer')?.style && (zone.querySelector('.timer').style.display = 'none');
        zone.querySelector('.dispatched-time')?.style && (zone.querySelector('.dispatched-time').style.display = 'none');
      } else if (zData.status === 'in-gate') {
        const bay = document.getElementById(zData.bayId) || bays[0];
        bay.appendChild(zone);
        if (zData.startTime) {
          const timerEl = zone.querySelector('.timer');
          timerEl.style.display = 'block';
          if (zone.dataset.interval) clearInterval(zone.dataset.interval);
          const startTime = zData.startTime;
          const interval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(diff / 60), secs = diff % 60;
            timerEl.textContent = `‚è± ${mins}m ${secs}s`;
          }, 1000);
          zone.dataset.interval = interval;
        }
      } else if (zData.status === 'dispatched') {
        dispatchedArea.appendChild(zone);
        if (zData.dispatchedTime) {
          const dispEl = zone.querySelector('.dispatched-time');
          dispEl.style.display = 'block';
          dispEl.textContent = `(Dispatched at: ${new Date(zData.dispatchedTime).toLocaleTimeString()})`;
        }
        if (zone.dataset.interval) { clearInterval(zone.dataset.interval); delete zone.dataset.interval; }
      }

      const badge = zone.querySelector('.seq-badge');
      if (zData.sequenceNumber != null) {
        badge.style.display = 'flex';
        badge.textContent = zData.sequenceNumber;
      } else {
        badge.style.display = 'none';
        badge.textContent = '';
      }
    }

    document.querySelectorAll('.zone').forEach(z => {
      if (data[z.id] && data[z.id].deleted) return;
      if (!data[z.id] && db) {
        const nm = z.querySelector('.name')?.textContent || z.id;
        set(ref(db, 'zones/' + z.id), { name: nm, status: 'pending' });
      }
    });

    document.querySelectorAll('.zone').forEach(z => {
      if (editMode) z.classList.add('show-minus'); else z.classList.remove('show-minus');
    });
  });
} else {
  console.error('Firebase database not initialized. Please refresh the page.');
  setTimeout(() => {
    if (document.getElementById('loginOverlay') && document.getElementById('loginOverlay').style.display === 'none') {
      alert('Database connection failed. Please refresh the page. If the problem persists, check your internet connection and try clearing your browser cache.');
    }
  }, 2000);
}

// startApp function - ensure everything is initialized
function startApp() {
  if (appStarted) return;
  appStarted = true;
  console.log('App started successfully');
}
</script>
</body>
</html>
