<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dispatch — Counters (Telegram Auto)</title>

<!-- Firebase JS SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --glass-bg: rgba(255,255,255,0.04);
  --glass-strong: rgba(255,255,255,0.12);
  --accent: #ffd700;
  --danger: #ff394f;
  --shadow: rgba(0,0,0,0.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  min-height:100vh;
  font-family: "SF Pro Display","Segoe UI",Roboto,system-ui,sans-serif;
  color:#fff;
  background: url('bg.jpg') center/cover no-repeat;
  -webkit-font-smoothing:antialiased;
  padding:26px;
}
/* layout */
.app { max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 280px 1fr; gap:18px; align-items:start; }
.card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:14px; box-shadow: 0 12px 34px var(--shadow); backdrop-filter: blur(14px) saturate(140%); position:relative; z-index:1; }
.header{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.h1{ font-size:20px; margin:0; }
.small{ font-size:13px; color:#ddd; }
.left { display:flex; flex-direction:column; gap:12px; position:relative; }

/* controls (pinned on top-left visually) */
.controls { display:flex; gap:10px; align-items:center; position:relative; z-index:10010; }
.icon-btn{ width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px var(--shadow); cursor:pointer; position:relative; z-index:10011; }
.icon-btn img{ width:20px; height:20px; opacity:0.95 }

/* floating panels - FORCE topmost and accept pointer events */
.panel-pop{ position:fixed; z-index:2147483647 !important; background: linear-gradient(180deg, rgba(20,20,20,0.98), rgba(20,20,20,0.92)); border-radius:14px; padding:12px; box-shadow:0 30px 80px rgba(0,0,0,0.6); color:#eaeaea; display:none; min-width:280px; transition:opacity .18s ease, transform .18s ease; pointer-events:auto; }
/* anchor origin will be set in JS; default transform origin */
.panel-pop.open{ display:block; opacity:1; transform: translateY(0); }
.panel-pop.hidden{ opacity:0; transform: translateY(-6px); }

/* content inside panels */
.panel-pop h4{ margin:0 0 8px 0; font-size:14px }
.panel-row{ display:flex; gap:8px; align-items:center }
.token-row{ display:flex; gap:8px; align-items:center; }
.token-mask{ letter-spacing:2px; font-family:monospace; padding:8px 10px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03); max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.token-actions .btn{ padding:6px 8px; font-size:13px }
.input{ width:100%; padding:8px 10px; border-radius:10px; border:none; background:rgba(255,255,255,0.02); color:white; margin-top:8px; }
.btn{ background:rgba(255,255,255,0.06); color:white; padding:8px 10px; border-radius:10px; border:none; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.3); }

/* main area: center counters horizontally and give focus */
.main{ display:flex; flex-direction:column; gap:14px; align-items:center; z-index:0; }
.header-main{ width:100%; display:flex; justify-content:space-between; align-items:center; }
.counters-wrap{ width:100%; display:flex; justify-content:center; align-items:flex-start; }
.counters{ display:flex; gap:24px; justify-content:center; align-items:flex-start; width:100%; max-width:820px; z-index:0; }

/* counter cards */
.counter{ flex:1; min-height:220px; border-radius:14px; padding:16px; position:relative; background: rgba(255,255,255,0.03); box-shadow: 0 16px 40px rgba(0,0,0,0.5); display:flex; flex-direction:column; z-index:0; }
.counter h3{ margin:0 0 10px 0; font-size:18px; }
.plus{ position:absolute; right:14px; bottom:14px; width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:30px; cursor:pointer; background:rgba(255,255,255,0.04); box-shadow:0 16px 36px rgba(0,0,0,0.45); }
.list{ display:flex; flex-direction:column; gap:10px; margin-top:6px; max-height:360px; overflow:auto; padding-right:6px; }
.entry{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background: rgba(0,0,0,0.06); }

/* modal styles (editor & zone modal) */
.modal-back{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index:10020; }
.modal{ width:720px; max-width:95%; background: linear-gradient(180deg, rgba(15,15,15,0.98), rgba(15,15,15,0.94)); padding:18px; border-radius:14px; backdrop-filter:blur(10px); box-shadow:0 30px 120px rgba(0,0,0,0.8); color:white; max-height:86vh; overflow:auto; }
.row{ display:flex; gap:8px; align-items:center; }
.zone-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background: rgba(255,255,255,0.02); margin-bottom:8px; }
.search{ width:100%; padding:8px; border-radius:10px; border:none; background: rgba(255,255,255,0.02); color:white; }

/* editor specific */
.editor-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
.editor-card{ padding:12px; border-radius:10px; background: rgba(255,255,255,0.02); }
.editor-list .editor-entry{ display:flex; justify-content:space-between; gap:12px; align-items:center; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; }
.editor-list .editor-actions{ display:flex; gap:8px; align-items:center; }

/* focus style to highlight counters visually */
.counters.focused { box-shadow: 0 0 0 4px rgba(255,215,0,0.06) inset, 0 30px 80px rgba(0,0,0,0.45); border-radius:16px; padding:12px; }

/* responsive */
@media (max-width:980px){ .app{ grid-template-columns: 1fr; padding:12px; } .left{ order:2 } .counters{ flex-direction:column; gap:18px; } .editor-grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="app">
  <!-- left column (controls) -->
  <div class="left">
    <div class="card" style="position:relative;">
      <div class="header">
        <div>
          <strong class="h1">Dispatch Controls</strong>
          <div class="small">Counters & helpers</div>
        </div>
        <!-- pinned controls (icons) -->
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="controls" id="topControls">
            <div class="icon-btn" id="editIcon" title="Edit zones & helpers">
              <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><path d='M12 20h9'/><path d='M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z'/></svg>" alt="edit">
            </div>
            <div class="icon-btn" id="exportIcon" title="Export / More">
              <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><path d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'/><polyline points='7 10 12 5 17 10'/><line x1='12' y1='5' x2='12' y2='19'/></svg>" alt="export">
            </div>
            <div class="icon-btn" id="activityIcon" title="Activity & Logs">
              <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><path d='M3 12h3l3 8 4-16 3 8h4'/></svg>" alt="activity">
            </div>
          </div>

          <!-- Panels (we will move these to document.body on first open) -->
          <div class="panel-pop" id="editPanel" data-anchor="edit" aria-hidden="true">
            <h4>Edit</h4>
            <div style="font-size:13px;color:#ddd;margin-bottom:8px">Manage zones & helpers. Assign helper to zone so messages go automatically when added to counters.</div>
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
              <div class="token-row">
                <div class="token-mask" id="tokenMask">●●●●●●●●●●●●●●●●</div>
              </div>
              <div class="token-actions">
                <button class="btn" id="revealTokenBtn">Show</button>
                <button class="btn" id="openEditorBtnSmall">Open</button>
              </div>
            </div>
            <div style="margin-top:8px;font-size:12px;color:#ccc">Use the editor to update helpers and zones.</div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:6px">
              <label for="botToken" style="font-size:12px;color:#ccc">Telegram Bot Token</label>
              <input id="botToken" class="input" placeholder="123456:ABC..." type="password">
              <div style="display:flex; gap:8px; justify-content:flex-end">
                <button class="btn" id="toggleTokenVisibilityBtn">Show</button>
                <button class="btn" id="saveBotTokenBtn">Save</button>
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:10px">
              <button class="btn" id="closeEditPanelBtn">Close</button>
            </div>
          </div>

          <div class="panel-pop" id="exportPanel" data-anchor="export" aria-hidden="true">
            <h4>Export</h4>
            <div style="font-size:13px;color:#ddd;">Export counters & helpers data.</div>
            <div style="display:flex;justify-content:flex-end;margin-top:10px">
              <button class="btn" id="exportCsvBtn">Export CSV</button>
              <button class="btn" id="closeExportPanelBtn">Close</button>
            </div>
          </div>

          <div class="panel-pop" id="activityPanel" data-anchor="activity" aria-hidden="true">
            <h4>Activity</h4>
            <div style="font-size:13px;color:#ddd;" id="activityContent">No recent activity yet.</div>
            <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
              <button class="btn" id="clearActivityBtn">Clear</button>
              <button class="btn" id="closeActivityPanelBtn">Close</button>
            </div>
          </div>

        </div>
      </div>

      <!-- removed the old warning per request -->
      <div style="margin-top:12px"></div>
    </div>
  </div>

  <!-- main column -->
  <div class="main">
    <div class="header-main" style="width:100%;max-width:820px;">
      <div><h2 style="margin:0">Dispatch — Counters</h2><div class="small" style="opacity:0.9">&nbsp;</div></div>
      <div class="small" style="opacity:0.9">&nbsp;</div>
    </div>

    <div class="counters-wrap">
      <div class="counters focused" id="countersArea" role="region" aria-label="Counters">
        <div class="counter card" id="counter1" tabindex="0" aria-label="Counter 1">
          <h3>Counter 1</h3>
          <div class="list" id="list1" aria-live="polite"></div>
          <div class="plus" data-counter="counter1" title="Add token to Counter 1">＋</div>
        </div>
        <div class="counter card" id="counter2" tabindex="0" aria-label="Counter 2">
          <h3>Counter 2</h3>
          <div class="list" id="list2" aria-live="polite"></div>
          <div class="plus" data-counter="counter2" title="Add token to Counter 2">＋</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Zone selection modal -->
<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="zoneSelectTitle">
    <h3 id="zoneSelectTitle">Select Zone to Add</h3>
    <input id="zoneSearch" class="search" placeholder="Type to search zones (predictive)">
    <div id="zoneList" style="margin-top:12px; max-height:320px; overflow:auto"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modalCancel" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Editor modal: manage zones & helpers -->
<div class="modal-back" id="editorModalBack">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
    <h3 id="editorTitle">Editor — Zones & Helpers</h3>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <input id="newZoneName" class="search" placeholder="New zone name (e.g. Dubai)">
      <button id="addZoneBtn" class="btn">Add Zone</button>
    </div>

    <div class="editor-grid" style="margin-top:12px;">
      <div class="editor-card">
        <h4 style="margin:0 0 8px 0">Zones</h4>
        <div id="zonesList" class="editor-list" style="margin-top:8px; max-height:360px; overflow:auto"></div>
      </div>

      <div class="editor-card">
        <h4 style="margin:0 0 8px 0">Helpers</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="helperName" class="search" placeholder="Helper name">
          <input id="helperPhone" class="search" placeholder="Phone (with country code)">
          <input id="helperTelegram" class="search" placeholder="Telegram ID (optional)">
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <select id="helperZoneSelect" class="search" style="min-width:160px"><option value="">Assign zone</option></select>
          <button id="addHelperBtn" class="btn">Add Helper</button>
        </div>
        <div id="helpersList" class="editor-list" style="max-height:300px; overflow:auto"></div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
      <button id="closeEditorBtn" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
/* -------------------------
   FIREBASE CONFIG & INIT
   ------------------------- */
/*
  NOTE: If your Realtime Database URL differs, replace databaseURL below
  with the exact URL from Firebase Console -> Realtime Database.
*/
const firebaseConfig = {
  apiKey: "AIzaSyDk_IDJAQZMBNtu57i_ls6wCsi3tzX19-A",
  authDomain: "helper-bb456.firebaseapp.com",
  databaseURL: "https://helper-bb456-default-rtdb.firebaseio.com",
  projectId: "helper-bb456",
  storageBucket: "helper-bb456.firebasestorage.app",
  messagingSenderId: "11179124401",
  appId: "1:11179124401:web:95bffde8f57e8f57962490",
  measurementId: "G-2FPWGR4KH2"
};

let db = null;
let usingRestFallback = false;
let restPollIntervalId = null;
let realtimeConnected = false;
const REST_POLL_MS = 3000;

// convenience base URL for Realtime DB REST
const RTDB_REST_BASE = (firebaseConfig.databaseURL || '').replace(/\/$/,'');

/* initialize compat SDK and try to setup real-time */
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.info('Firebase initialized (compat)');
} catch (e) {
  console.error('Firebase init error', e);
  db = null;
}

/* -------------------------
   Configuration
   ------------------------- */
let BOT_TOKEN = '';
// key to read the Google Apps Script URL from localStorage
const PROXY_CONFIG_KEY = 'dispatch_proxy_url';

// keep a short-term sent set to prevent double-send (in-memory + persisted)
const SENT_SET_KEY = 'dispatch_recent_sends'; // also stored in localStorage for persistence
let sentSet = new Set();
try {
  const raw = localStorage.getItem(SENT_SET_KEY);
  if(raw) JSON.parse(raw || '[]').forEach(k=> sentSet.add(k));
} catch(e){}

/* -------------------------
   App state and main logic (unchanged mostly)
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const state = {
    zones: {},        // { zid: { name } }
    helpers: {},      // { hid: { name, phone, telegramId, zid } }
    counters: { counter1: [], counter2: [] }, // arrays of { zid, seq }
    nextSeq: 1,
    nextZoneId: 1,
    nextHelperId: 1,
    activity: []
  };

  function ensureStateShape(){
    if(!state || typeof state !== 'object') return;
    state.zones = state.zones && typeof state.zones === 'object' ? state.zones : {};
    state.helpers = state.helpers && typeof state.helpers === 'object' ? state.helpers : {};
    if(!state.counters || typeof state.counters !== 'object') state.counters = { counter1: [], counter2: [] };
    if(!Array.isArray(state.counters.counter1)) state.counters.counter1 = [];
    if(!Array.isArray(state.counters.counter2)) state.counters.counter2 = [];
    state.nextSeq = Number.isFinite(state.nextSeq) ? state.nextSeq : 1;
    state.nextZoneId = Number.isFinite(state.nextZoneId) ? state.nextZoneId : 1;
    state.nextHelperId = Number.isFinite(state.nextHelperId) ? state.nextHelperId : 1;
    state.activity = Array.isArray(state.activity) ? state.activity : [];
  }

  // Elements
  const list1 = document.getElementById('list1');
  const list2 = document.getElementById('list2');
  const modalBack = document.getElementById('modalBack');
  const editorModalBack = document.getElementById('editorModalBack');
  const zoneList = document.getElementById('zoneList');
  const zoneSearch = document.getElementById('zoneSearch');
  const openEditorBtnSmall = document.getElementById('openEditorBtnSmall');

  // panels: we'll move these to body to avoid stacking context issues
  const panels = {
    edit: document.getElementById('editPanel'),
    export: document.getElementById('exportPanel'),
    activity: document.getElementById('activityPanel')
  };

  // move panel elements to document.body so they float above everything
  Object.values(panels).forEach(p=>{
    if(p && p.parentElement !== document.body){
      document.body.appendChild(p);
    }
  });

  function positionPanel(panelEl, anchorEl){
    if(!panelEl || !anchorEl) return;
    panelEl.style.position = 'fixed';
    // ensure visible so measurements work
    const prevDisplay = panelEl.style.display;
    panelEl.style.display = 'block';
    panelEl.style.transform = 'translateY(0)';
    const r = anchorEl.getBoundingClientRect();
    const desiredTop = r.bottom + 8 + window.scrollY;
    const pw = panelEl.offsetWidth || 300;
    // left aligned with icon (clamped)
    let left = Math.max(8 + window.scrollX, Math.min(r.left + window.scrollX, window.innerWidth - pw - 8));
    panelEl.style.top = `${Math.min(desiredTop, window.innerHeight + window.scrollY - panelEl.offsetHeight - 8)}px`;
    panelEl.style.left = `${left}px`;
    panelEl.style.zIndex = '2147483647';
    if(prevDisplay) panelEl.style.display = prevDisplay;
  }

  const editIcon = document.getElementById('editIcon');
  const exportIcon = document.getElementById('exportIcon');
  const activityIcon = document.getElementById('activityIcon');

  // Editor elements
  const editorZonesList = document.getElementById('zonesList');
  const zonesSelect = document.getElementById('helperZoneSelect');
  const addZoneBtn = document.getElementById('addZoneBtn');
  const newZoneName = document.getElementById('newZoneName');
  const addHelperBtn = document.getElementById('addHelperBtn');
  const helperName = document.getElementById('helperName');
  const helperPhone = document.getElementById('helperPhone');
  const helpersList = document.getElementById('helpersList');
  const helperTelegram = document.getElementById('helperTelegram');
  const botTokenInput = document.getElementById('botToken');
  const saveBotTokenBtn = document.getElementById('saveBotTokenBtn');
  const toggleTokenVisibilityBtn = document.getElementById('toggleTokenVisibilityBtn');
  const revealTokenBtn = document.getElementById('revealTokenBtn');
  const tokenMask = document.getElementById('tokenMask');

  // Activity content box
  const activityContent = document.getElementById('activityContent');

  /* -------------------------
     Firebase <-> REST fallback helpers
     ------------------------- */

  function logActivityLine(line){
    state.activity.push(`${new Date().toLocaleString()} — ${line}`);
    renderActivity();
  }

  // start REST polling (GET) to fetch DB every REST_POLL_MS
  function startRestPoll(){
    if(usingRestFallback) return;
    usingRestFallback = true;
    if(db && typeof db.ref === 'function'){
      try {
        db.ref('dispatch_state').off();
      } catch(e){}
    }
    logActivityLine('Realtime not available — switching to REST fallback (polling).');
    restPollIntervalId = setInterval(()=> {
      fetch(`${RTDB_REST_BASE}/dispatch_state.json`)
        .then(r => {
          if(!r.ok) throw new Error('REST GET failed');
          return r.json();
        })
        .then(remote => {
          if(remote){
            try {
              Object.keys(state).forEach(k => delete state[k]);
              Object.assign(state, remote || {});
              ensureStateShape();
              renderAll();
            } catch(e){
              console.error('apply remote (REST) error', e);
            }
          }
        })
        .catch(err => {
          console.warn('REST poll error', err);
        });
    }, REST_POLL_MS);
  }

  function stopRestPoll(){
    if(restPollIntervalId) clearInterval(restPollIntervalId);
    restPollIntervalId = null;
    usingRestFallback = false;
    logActivityLine('Stopped REST fallback; attempting realtime again.');
  }

  // Try to start realtime listener with health detection (.info/connected)
  let infoConnectedListener = null;
  let dispatchStateListener = null;
  function startRealtimeListener(){
    if(!db || !db.ref) {
      console.info('No db available to start realtime; will use REST fallback');
      startRestPoll();
      return;
    }

    // reset flags
    realtimeConnected = false;

    // listen to .info/connected to know if connection established
    try {
      if(infoConnectedListener) db.ref('.info/connected').off('value', infoConnectedListener);
    } catch(e){}

    infoConnectedListener = (snap) => {
      const val = snap && snap.val();
      if(val === true){
        realtimeConnected = true;
        // if we had been using REST fallback, stop it
        if(usingRestFallback){
          stopRestPoll();
        }
        logActivityLine('Realtime DB connected (via .info/connected).');
      } else {
        // when false: not connected; fallback
        realtimeConnected = false;
        // start REST fallback if not already started
        startRestPoll();
      }
    };

    try {
      db.ref('.info/connected').on('value', infoConnectedListener);
    } catch(e){ console.warn('Error attaching .info/connected listener', e); startRestPoll(); }

    // attach main state listener
    try {
      if(dispatchStateListener) db.ref('dispatch_state').off('value', dispatchStateListener);
    } catch(e){}

    dispatchStateListener = (snap) => {
      if(!snap.exists()) return;
      try {
        const remote = snap.val();
        // apply remote state to local state (replace)
        Object.keys(state).forEach(k => delete state[k]);
        Object.assign(state, remote || {});
        ensureStateShape();
        renderAll();
        console.info('State updated from Firebase (realtime).');
      } catch(e){
        console.error('Error applying remote state', e);
      }
    };

    try {
      db.ref('dispatch_state').on('value', dispatchStateListener, (err) => {
        console.warn('Realtime listener error', err);
        // on any listener error, fallback to REST polling
        startRestPoll();
      });
      // set a short timer: if .info/connected doesn't flip true, fallback
      setTimeout(()=> {
        if(!realtimeConnected && !usingRestFallback){
          console.warn('Realtime did not connect within timeout — switching to REST fallback');
          startRestPoll();
        }
      }, 5500);
    } catch(e){
      console.error('Error attaching dispatch_state listener', e);
      startRestPoll();
    }
  }

  // call at startup attempt
  startRealtimeListener();

  // If the window goes online, re-attempt realtime after short delay
  window.addEventListener('online', ()=> {
    setTimeout(()=> {
      if(usingRestFallback && db) {
        logActivityLine('Network back — attempting to re-enable realtime listener.');
        startRealtimeListener();
      }
    }, 1200);
  });

  // When the page is hidden then shown, reattempt if in REST mode
  document.addEventListener('visibilitychange', ()=> {
    if(document.visibilityState === 'visible' && usingRestFallback && db){
      startRealtimeListener();
    }
  });

  /* -------------------------
     SaveToFirebase (writes)
     ------------------------- */
  function saveToFirebase(){
    if(db && !usingRestFallback){
      try {
        db.ref('dispatch_state').set(state).catch(err=>{
          console.error('saveToFirebase error (sdk)', err);
          saveToFirebaseRest();
        });
        return;
      } catch(e){
        console.error('saveToFirebase exception (sdk)', e);
        saveToFirebaseRest();
        return;
      }
    }
    saveToFirebaseRest();
  }

  function saveToFirebaseRest(){
    if(!RTDB_REST_BASE) { console.error('No REST base URL'); return; }
    try {
      fetch(`${RTDB_REST_BASE}/dispatch_state.json`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state)
      }).then(resp => {
        if(!resp.ok) throw new Error('REST PUT failed');
        return resp.json();
      }).then(() => {
        console.info('Saved via REST PUT');
      }).catch(err => {
        console.warn('REST PUT save error', err);
      });
    } catch(e){
      console.error('saveToFirebaseRest exception', e);
    }
  }

  function loadFromFirebaseOnce(){
    if(db && !usingRestFallback){
      return db.ref('dispatch_state').once('value').then(snap=>{
        if(!snap.exists()) return null;
        return snap.val();
      }).catch(e=> {
        console.error('loadFromFirebaseOnce (sdk) error', e);
        return fetch(`${RTDB_REST_BASE}/dispatch_state.json`).then(r=>{
          if(!r.ok) return null;
          return r.json();
        }).catch(()=> null);
      });
    }
    return fetch(`${RTDB_REST_BASE}/dispatch_state.json`).then(r=>{
      if(!r.ok) return null;
      return r.json();
    }).catch(e=> { console.error('loadFromFirebaseOnce (rest) error', e); return null; });
  }

  /* -------------------------
     Render helpers / zones / counters
     ------------------------- */
  function renderZonesInEditor() {
    editorZonesList.innerHTML = '';
    zonesSelect.innerHTML = '<option value="">Assign zone</option>';
    Object.keys(state.zones).forEach(zid => {
      const z = state.zones[zid];
      const div = document.createElement('div');
      div.className = 'editor-entry';
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      div.style.padding = '8px';
      div.style.marginBottom = '8px';
      div.style.borderRadius = '8px';
      div.style.background = 'rgba(255,255,255,0.02)';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${z.name}</div><div style="font-size:12px;color:#ccc">ID: <code>${zid}</code></div>`;
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '8px';
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit';
      edit.addEventListener('click', ()=> {
        const newName = prompt('Zone name:', z.name) ?? z.name;
        let newId = prompt('Zone ID:', zid) ?? zid;
        newId = (newId||'').trim();
        if(!newId) return;
        if(newId !== zid){
          if(state.zones[newId]){ alert('ID already exists'); return; }
          state.zones[newId] = { name: newName };
          delete state.zones[zid];
          Object.keys(state.helpers).forEach(hid=>{ if(state.helpers[hid].zid===zid) state.helpers[hid].zid=newId; });
          Object.keys(state.counters).forEach(cnt=>{
            state.counters[cnt] = state.counters[cnt].map(e=> e.zid===zid? {...e, zid:newId}: e);
          });
        } else {
          state.zones[zid].name = newName;
        }
        renderAll();
      });
      const del = document.createElement('button'); del.className='btn'; del.textContent='Delete';
      del.addEventListener('click', ()=> {
        delete state.zones[zid];
        Object.keys(state.helpers).forEach(hid=>{
          if(state.helpers[hid].zid === zid) state.helpers[hid].zid = '';
        });
        renderAll();
      });
      actions.appendChild(edit);
      actions.appendChild(del);
      div.appendChild(left);
      div.appendChild(actions);
      editorZonesList.appendChild(div);

      const opt = document.createElement('option');
      opt.value = zid; opt.text = z.name;
      zonesSelect.appendChild(opt);
    });
  }

  function renderHelpersInEditor(){
    helpersList.innerHTML = '';
    Object.keys(state.helpers).forEach(hid=>{
      const h = state.helpers[hid];
      const div = document.createElement('div');
      div.className='editor-entry';
      div.style.display='flex';
      div.style.justifyContent='space-between';
      div.style.alignItems='center';
      div.style.padding='8px';
      div.style.marginBottom='8px';
      div.style.borderRadius='8px';
      div.style.background='rgba(255,255,255,0.02)';
      const left = document.createElement('div');
      left.innerHTML = `<div style=\"font-weight:700\">${h.name}</div><div style=\"font-size:12px;color:#ccc\">ID: <code>${hid}</code> · TelID: ${h.telegramId||'-'}<br>${h.phone} ${h.zid? '— ' + (state.zones[h.zid]?.name||'') : ''}</div>`;
      const actions = document.createElement('div');
      actions.style.display='flex'; actions.style.gap='8px';
      const del = document.createElement('button'); del.className='btn'; del.textContent='Delete';
      del.addEventListener('click', ()=> { delete state.helpers[hid]; renderAll(); });
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit';
      edit.addEventListener('click', ()=> {
        helperName.value = h.name;
        helperPhone.value = h.phone;
        helperTelegram.value = h.telegramId||'';
        zonesSelect.value = h.zid || '';
        helperName.dataset.editingId = hid;
        helperName.focus();
      });
      actions.appendChild(edit); actions.appendChild(del);
      div.appendChild(left); div.appendChild(actions);
      helpersList.appendChild(div);
    });
  }

  function renderZonesForModal(){
    zoneList.innerHTML = '';
    const q = zoneSearch.value?.toLowerCase?.() || '';
    let shown = 0;
    Object.keys(state.zones).forEach(zid=>{
      const z = state.zones[zid];
      if(!z || !z.name) return;
      if(q && !z.name.toLowerCase().includes(q)) return;
      const row = document.createElement('div');
      row.className='zone-row';
      row.innerHTML = `<div><strong>${z.name}</strong></div>`;
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Add';
      btn.addEventListener('click', ()=> assignZone(zid));
      row.appendChild(btn);
      zoneList.appendChild(row);
      shown++;
    });
    if(shown === 0){
      const empty = document.createElement('div');
      empty.className = 'zone-row';
      empty.style.justifyContent = 'center';
      empty.innerHTML = '<div style="opacity:0.8">No zones available. Open Editor to add zones.</div>';
      zoneList.appendChild(empty);
    }
  }

  function renderCounters(){
    list1.innerHTML = ''; list2.innerHTML = '';

    const renderEntry = (container, a, counterName)=>{
      const e = document.createElement('div');
      e.className='entry';
      const zoneName = state.zones[a.zid]?.name || a.zid;
      const helperId = Object.keys(state.helpers).find(hk => state.helpers[hk].zid === a.zid);
      const helper = helperId ? state.helpers[helperId] : null;
      const helperLine = helper ? `<div style="font-size:12px;color:#ddd;margin-top:4px">${helper.name} · ${helper.phone}</div>` : '';

      const left = document.createElement('div');
      left.innerHTML = `<div><strong>${zoneName}</strong> — Token ${a.seq}</div>${helperLine}`;

      const right = document.createElement('div');
      const rm = document.createElement('button');
      rm.className = 'btn';
      rm.title = 'Remove';
      rm.textContent = '×';
      rm.addEventListener('click', ()=> removeFromCounter(counterName, a.seq));
      right.appendChild(rm);

      e.style.display = 'flex';
      e.style.justifyContent = 'space-between';
      e.style.alignItems = 'center';
      e.appendChild(left);
      e.appendChild(right);
      container.appendChild(e);
    };

    state.counters.counter1.forEach(a=> renderEntry(list1, a, 'counter1'));
    state.counters.counter2.forEach(a=> renderEntry(list2, a, 'counter2'));
  }

  function removeFromCounter(counterName, seq){
    const idx = state.counters[counterName].findIndex(e=> e.seq === seq);
    if(idx > -1){
      const entry = state.counters[counterName][idx];
      state.counters[counterName].splice(idx,1);
      const zn = state.zones[entry.zid]?.name || entry.zid;
      state.activity.push(`${new Date().toLocaleString()} — ${zn} token ${entry.seq} removed from ${counterName}`);
      renderCounters();
      renderActivity();
      try { saveToFirebase(); } catch(e){ console.error('removeFromCounter saveToFirebase', e); }
    }
  }

  function renderActivity(){
    // Only show lines about tokens added/removed
    const lines = (state.activity || []).slice(-200).reverse();
    const filtered = lines.filter(l => /\btoken\b/i.test(l) && (/\badded\b/i.test(l) || /\bremoved\b/i.test(l)));
    if(filtered.length === 0){
      activityContent.textContent = 'No recent activity yet.';
    } else {
      activityContent.innerHTML = filtered.slice(0,50).map(it=>`<div style="margin-bottom:6px;font-size:13px">${it}</div>`).join('');
    }
  }

  // renderAll: persists to Firebase automatically
  function renderAll(){
    renderZonesInEditor();
    renderHelpersInEditor();
    renderCounters();
    renderActivity();
    try { saveToFirebase(); } catch(e){ console.error('renderAll saveToFirebase', e); }
  }

  /* -------------------------
     Interaction: open/close panels and editor
     ------------------------- */
  function closePanels(){
    Object.values(panels).forEach(p=>{
      p.classList.remove('open');
      p.classList.add('hidden');
      p.style.display = 'none';
      p.setAttribute('aria-hidden','true');
    });
  }

  function togglePanel(name){
    const p = panels[name];
    if(!p) return;
    const isOpen = p.classList.contains('open');
    closePanels();
    if(!isOpen){
      p.style.display = 'block';
      p.classList.remove('hidden');
      p.classList.add('open');
      p.setAttribute('aria-hidden','false');
      const anchorMap = { edit: editIcon, export: exportIcon, activity: activityIcon };
      positionPanel(p, anchorMap[name]);
    }
  }

  // prevent clicks inside panels from closing them
  Object.values(panels).forEach(p=>{
    p.addEventListener('click', (ev)=> ev.stopPropagation());
  });

  // Reposition open panel(s) on resize or scroll to keep them under icons
  function repositionOpenPanels(){
    Object.entries(panels).forEach(([name, p])=>{
      if(p.classList.contains('open')){
        const anchorMap = { edit: editIcon, export: exportIcon, activity: activityIcon };
        positionPanel(p, anchorMap[name]);
      }
    });
  }
  window.addEventListener('resize', repositionOpenPanels);
  window.addEventListener('scroll', repositionOpenPanels);

  editIcon.addEventListener('click', (e)=>{ e.stopPropagation(); togglePanel('edit'); });
  exportIcon.addEventListener('click', (e)=>{ e.stopPropagation(); togglePanel('export'); });
  activityIcon.addEventListener('click', (e)=>{ e.stopPropagation(); togglePanel('activity'); });

  document.addEventListener('click', ()=> closePanels());

  document.getElementById('closeEditPanelBtn').addEventListener('click', (e)=>{ e.stopPropagation(); closePanels(); });
  document.getElementById('closeExportPanelBtn').addEventListener('click', (e)=>{ e.stopPropagation(); closePanels(); });
  document.getElementById('closeActivityPanelBtn').addEventListener('click', (e)=>{ e.stopPropagation(); closePanels(); });
  document.getElementById('clearActivityBtn').addEventListener('click', (e)=>{
    e.stopPropagation();
    state.activity = [];
    renderActivity();
    try { saveToFirebase(); } catch(e2){ console.error('clearActivity saveToFirebase', e2); }
  });

  /* -------------------------
     Editor open from panel button (should NOT close panel)
     ------------------------- */
  openEditorBtnSmall.addEventListener('click', (e)=> {
    e.stopPropagation();
    closePanels();
    editorModalBack.style.display = 'flex';
    renderAll();
  });

  /* -------------------------
     Bot token UI
     ------------------------- */
  let tokenUnlocked = false;
  function updateTokenUI(){
    if(!tokenUnlocked){
      botTokenInput.disabled = true;
      botTokenInput.type = 'password';
      toggleTokenVisibilityBtn.textContent = 'Show';
      revealTokenBtn.textContent = 'Unlock';
    } else {
      botTokenInput.disabled = false;
      botTokenInput.type = 'text';
      toggleTokenVisibilityBtn.textContent = 'Hide';
      revealTokenBtn.textContent = 'Lock';
    }
  }
  function requirePasscode(){
    const passcode = prompt('Enter passcode to unlock bot token');
    return passcode === '923623';
  }
  try { BOT_TOKEN = localStorage.getItem('dispatch_bot_token') || ''; } catch(_){}
  if(BOT_TOKEN && botTokenInput){ botTokenInput.value = BOT_TOKEN; }
  updateTokenUI();

  saveBotTokenBtn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(!tokenUnlocked && !requirePasscode()) return;
    tokenUnlocked = true;
    BOT_TOKEN = botTokenInput.value.trim();
    try { localStorage.setItem('dispatch_bot_token', BOT_TOKEN); } catch(_){ }
    updateTokenUI();
  });
  toggleTokenVisibilityBtn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(!tokenUnlocked && !requirePasscode()) return;
    tokenUnlocked = true;
    if(!botTokenInput) return;
    const isPwd = botTokenInput.type === 'password';
    botTokenInput.type = isPwd ? 'text' : 'password';
    toggleTokenVisibilityBtn.textContent = isPwd ? 'Hide' : 'Show';
    updateTokenUI();
  });
  revealTokenBtn?.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(!tokenUnlocked){
      if(!requirePasscode()) return;
      tokenUnlocked = true;
    } else {
      tokenUnlocked = false;
    }
    updateTokenUI();
  });

  /* -------------------------
     Telegram send (proxy via Google Apps Script preferred)
     - Single-send guarantee using 'sentSet'
     ------------------------- */

  // read configured Apps Script URL
  function getAppsScriptUrl(){
    try {
      const u = localStorage.getItem(PROXY_CONFIG_KEY);
      if(u && typeof u === 'string' && u.trim()) return u.trim();
    } catch(e){}
    return '';
  }

  // persist sentSet (rolloff older entries to keep small)
  function persistSentSet(){
    try {
      const arr = Array.from(sentSet).slice(-200); // keep last 200
      localStorage.setItem(SENT_SET_KEY, JSON.stringify(arr));
    } catch(e){}
  }

  async function sendViaAppsScript(appsUrl, botToken, chatId, text){
    try {
      const resp = await fetch(appsUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ botToken, chatId, text }),
        mode: 'cors',
        cache: 'no-cache'
      });
      return resp && (resp.ok || resp.status === 200 || resp.status === 204);
    } catch(e){
      return false;
    }
  }

  // fallback direct beacon (no-cors) + image
  function sendDirectBeacon(botToken, chatId, text){
    if(!botToken || !chatId) return;
    const url = `https://api.telegram.org/bot${encodeURIComponent(botToken)}/sendMessage?chat_id=${encodeURIComponent(chatId)}&text=${encodeURIComponent(text)}`;
    try {
      try { fetch(url, { method: 'GET', mode: 'no-cors', cache: 'no-cache' }).catch(()=>{}); } catch(_){}
      const img = new Image();
      img.src = url + `&_cb=${Date.now()}`;
    } catch(e){}
  }

  // single function that ensures single send
  async function sendTelegramMessageSingle(chatId, text, uniqueKey){
    if(!chatId || !text) return;
    if(!BOT_TOKEN) {
      try { BOT_TOKEN = localStorage.getItem('dispatch_bot_token') || ''; } catch(_){}
      if(!BOT_TOKEN) return;
    }
    // if we already sent this uniqueKey recently, skip
    if(sentSet.has(uniqueKey)) return;
    // mark as sent (optimistic) to prevent re-send during network retries
    sentSet.add(uniqueKey);
    persistSentSet();

    // try Apps Script proxy first
    const appsUrl = getAppsScriptUrl();
    if(appsUrl){
      const ok = await sendViaAppsScript(appsUrl, BOT_TOKEN, chatId, text);
      if(ok) return;
      // if not ok, remove the optimistic mark so fallback attempts can try later
      // but keep duplicate protection for a short time (we'll still remove)
    }

    // fallback to direct beacon
    sendDirectBeacon(BOT_TOKEN, chatId, text);
  }

  function normalizeUaePhone(input){
    let s = (input||'').replace(/\D+/g,'');
    if(!s) return input;
    if(s.startsWith('971')) return `+${s}`;
    if(s.startsWith('0')) s = s.substring(1);
    if(s.startsWith('5')) return `+971${s}`;
    return `+971${s}`;
  }

  document.getElementById('closeEditorBtn').addEventListener('click', ()=> {
    editorModalBack.style.display = 'none';
  });

  // clicking inside editor should not close it
  document.querySelector('#editorModalBack .modal')?.addEventListener?.('click', e=> e.stopPropagation?.());

  // clicking modal backdrop closes the editor
  editorModalBack.addEventListener('click', (e)=> {
    if(e.target === editorModalBack) editorModalBack.style.display = 'none';
  });

  /* -------------------------
     Zone modal open/close (counters)
     ------------------------- */
  let activeCounter = null;
  document.querySelectorAll('.plus').forEach(b=>{
    b.addEventListener('click', (ev)=> {
      ev.stopPropagation();
      activeCounter = b.getAttribute('data-counter');
      modalBack.style.display='flex';
      zoneSearch.value = '';
      renderZonesForModal();
    });
  });
  document.getElementById('modalCancel').addEventListener('click', ()=> modalBack.style.display='none');
  modalBack.addEventListener('click', (e)=> { if(e.target === modalBack) modalBack.style.display='none'; });
  zoneSearch.addEventListener('input', renderZonesForModal);

  /* -------------------------
     Assign zone -> counter (and send message)
     ------------------------- */
  function assignZone(zid){
    const seq = state.nextSeq++;
    state.counters[activeCounter].push({ zid, seq });
    modalBack.style.display='none';
    renderCounters();

    const helperId = Object.keys(state.helpers).find(hk => state.helpers[hk].zid === zid);
    const helper = helperId ? state.helpers[helperId] : null;

    const payload = {
      counter: activeCounter,
      zone: state.zones[zid].name,
      zoneId: zid,
      token: seq,
      helper: helper ? { id: helperId, name: helper.name, phone: helper.phone, telegramId: helper.telegramId||'' } : null,
      timestamp: new Date().toISOString()
    };

    // activity: only log add
    state.activity.push(`${new Date().toLocaleString()} — ${payload.zone} token ${payload.token} added to ${payload.counter}`);
    renderActivity();

    // Send Telegram message once (proxy-first). Use uniqueKey to prevent duplicates
    if(helper && helper.telegramId){
      const msg = `${helper.name} Please come to ${payload.counter.replace('counter','Counter ')} — ${payload.zone} — Token ${payload.token}`;
      const uniqueKey = `${payload.zoneId}_${payload.token}_${payload.counter}`;
      // send asynchronously but single-shot
      sendTelegramMessageSingle(helper.telegramId, msg, uniqueKey).catch(()=>{});
    }

    // persist after assignment
    try { saveToFirebase(); } catch(e){ console.error('assignZone saveToFirebase', e); }
  }

  /* -------------------------
     Editor: add zone & helpers
     ------------------------- */
  addZoneBtn.addEventListener('click', ()=> {
    const name = (newZoneName.value||'').trim();
    if(!name) return alert('Enter zone name');
    if(!Number.isFinite(state.nextZoneId)) state.nextZoneId = 1;
    const zid = 'z' + (state.nextZoneId++);
    state.zones[zid] = { name };
    newZoneName.value = '';
    renderAll();
  });

  addHelperBtn.addEventListener('click', ()=> {
    const name = (helperName.value||'').trim();
    let phone = (helperPhone.value||'').trim();
    const telegramId = (helperTelegram.value||'').trim();
    const zid = zonesSelect.value || '';
    if(!name || !phone) return alert('Enter helper name & phone');
    phone = normalizeUaePhone(phone);
    const editingId = helperName.dataset.editingId;
    if(editingId){
      const newId = prompt('Helper ID (optional to change):', editingId) || editingId;
      const finalId = newId.trim();
      if(finalId !== editingId && state.helpers[finalId]){ alert('Helper ID already exists'); return; }
      delete state.helpers[editingId];
      state.helpers[finalId] = { name, phone, telegramId, zid };
      delete helperName.dataset.editingId;
    } else {
      const hid = 'h' + (state.nextHelperId++);
      state.helpers[hid] = { name, phone, telegramId, zid };
    }
    helperName.value = ''; helperPhone.value = ''; helperTelegram.value=''; zonesSelect.value = '';
    renderAll();
  });

  // Export CSV (simple)
  document.getElementById('exportCsvBtn').addEventListener('click', (e)=> {
    e.stopPropagation();
    let csv = 'type,id,name,extra\n';
    Object.keys(state.zones).forEach(zid=> csv += `zone,${zid},"${state.zones[zid].name}",\n`);
    Object.keys(state.helpers).forEach(hid=> csv += `helper,${hid},"${state.helpers[hid].name}","${state.helpers[hid].phone}|${state.helpers[hid].telegramId||''}|${state.helpers[hid].zid||''}"\n`);
    Object.keys(state.counters).forEach(cnt=>{
      state.counters[cnt].forEach(entry=>{
        csv += `counter,${cnt},"${state.zones[entry.zid]?.name||entry.zid}","token:${entry.seq}"\n`;
      });
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'dispatch_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  /* -------------------------
     Sample seed data (only if DB empty)
     ------------------------- */
  (function seedAndLoadFirebase(){
    loadFromFirebaseOnce().then(remote=>{
      if(remote){
        try {
          Object.keys(state).forEach(k => delete state[k]);
          Object.assign(state, remote || {});
          ensureStateShape();
        } catch(e){ console.error('apply remote on load', e); }
        renderAll();
      } else {
        const z1 = 'z' + (state.nextZoneId++); state.zones[z1] = { name:'Ajman' };
        const z2 = 'z' + (state.nextZoneId++); state.zones[z2] = { name:'Dubai' };
        const z3 = 'z' + (state.nextZoneId++); state.zones[z3] = { name:'Sharjah' };
        renderAll();
        try { saveToFirebase(); } catch(e){ console.error('seed saveToFirebase', e); }
      }
    }).catch(e=> {
      console.error('seedAndLoadFirebase error', e);
      const z1 = 'z' + (state.nextZoneId++); state.zones[z1] = { name:'Ajman' };
      const z2 = 'z' + (state.nextZoneId++); state.zones[z2] = { name:'Dubai' };
      const z3 = 'z' + (state.nextZoneId++); state.zones[z3] = { name:'Sharjah' };
      renderAll();
    });
  })();

  /* -------------------------
     Keyboard focus / a11y: focus counters when page loads
     ------------------------- */
  const countersArea = document.getElementById('countersArea');
  setTimeout(()=> { countersArea.scrollIntoView({behavior:'smooth', block:'center'}); }, 120);

  /* -------------------------
     Prevent accidental closing while interacting with panels
     ------------------------- */
  document.getElementById('topControls').addEventListener('click', e=> e.stopPropagation());

  /* -------------------------
     Finish: initial render
     ------------------------- */
  // initial render handled in seed/load
}); // DOMContentLoaded
</script>
</body>
</html>